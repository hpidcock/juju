name: "Tests Wildcard"
on: [push, pull_request]
jobs:
  linux-amd64:
    name: linux-amd64
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
    - name: Set up Go 1.14
      uses: actions/setup-go@v1
      with:
        go-version: "1.14"
      id: go
    - name: Checkout
      uses: actions/checkout@v2
    - name: Install
      run: |
        set -euxo pipefail
        sudo apt-get remove lxd lxd-client
        sudo snap install lxd
        sudo lxd waitready
        sudo lxd init --auto
        sudo chmod a+wr /var/snap/lxd/common/lxd/unix.socket
        sudo snap install juju-db
        GO111MODULE=off go get -u github.com/hpidcock/gophertest
        echo "##[add-path]/snap/bin"
        echo "##[add-path]$(go env GOPATH)/bin"
    - name: Build
      run: |
        go mod download
        go list github.com/juju/juju/... |
        grep -v "github.com/juju/juju/cmd/jujud/agent" |
        grep -v "github.com/juju/juju/featuretests" |
        grep -v "github.com/juju/juju/worker/uniter" |
        grep -v "github.com/juju/juju/state" |
        gophertest -stdin -v -a -u
    - name: Run
      run: |
        ./gopher.test -c 4 -- -check.v
